@page "/sales"
@layout ClothsStoreSys.Shared.AdminLayout
@inject ClothsStoreSys.Data.AppDbContext Db
@inject Microsoft.Extensions.Localization.IStringLocalizer<ClothsStoreSys.SharedResources> L
@inject ClothsStoreSys.Services.IItemService ItemService
@inject ClothsStoreSys.Services.IInvoiceService InvoiceService

<h3>@L["SalesPOS"]</h3>

@if (items == null)
{
    <p>@L["Loading"]...</p>
}
else
{
    <div>
        <select @onchange="AddToCart">
            <option value="">@L["SelectItem"]</option>
            @foreach (var it in items)
            {
                <option value="@it.Id">@it.Name - @it.UnitPrice.ToString("C") (@it.StockQty)</option>
            }
        </select>
    </div>

    <table class="table">
        <thead>
            <tr><th>@L["Item"]</th><th>@L["Qty"]</th><th>@L["Unit"]</th><th>@L["Discount"]</th><th>@L["Total"]</th></tr>
        </thead>
        <tbody>
            @foreach (var c in cart)
            {
                <tr>
                    <td>@c.Item.Name</td>
                    <td>@c.Quantity</td>
                    <td>@c.UnitPrice.ToString("C")</td>
                    <td>@(c.ItemDiscountAmount.ToString("C"))</td>
                    <td>@(c.Total.ToString("C"))</td>
                </tr>
            }
        </tbody>
    </table>

    <div>
        <label>@L["InvoiceDiscountType"]</label>
        <select @bind="invoiceDiscountType">
            <option value="None">@L["None"]</option>
            <option value="Fixed">@L["Fixed"]</option>
            <option value="Percent">@L["Percent"]</option>
        </select>
        <input type="number" @bind="invoiceDiscountValue" />
    </div>

    <div>
        <p>@L["Subtotal"]: @subtotal.ToString("C")</p>
        <p>@L["InvoiceDiscount"]: @invoiceDiscountAmount.ToString("C")</p>
        <p>@L["Total"]: @total.ToString("C")</p>
    </div>

    <button class="btn btn-primary" @onclick="Finalize">@L["Finalize"]</button>
}

@code {
    List<ClothsStoreSys.Models.Item> items;
    List<ClothsStoreSys.Models.InvoiceItem> cart = new();

    decimal subtotal = 0;
    ClothsStoreSys.Models.DiscountType invoiceDiscountType = ClothsStoreSys.Models.DiscountType.None;
    decimal invoiceDiscountValue = 0;
    decimal invoiceDiscountAmount = 0;
    decimal total = 0;

    protected override async Task OnInitializedAsync()
    {
        items = await ItemService.GetAllAsync();
    }

    private async Task AddToCart(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var id))
        {
            var it = await ItemService.GetByIdAsync(id);
            if (it != null)
            {
                var ii = new ClothsStoreSys.Models.InvoiceItem
                {
                    ItemId = it.Id,
                    Item = it,
                    Quantity = 1,
                    UnitPrice = it.UnitPrice,
                    ItemDiscountType = ClothsStoreSys.Models.DiscountType.None
                };
                cart.Add(ii);
                Recalculate();
            }
        }
    }

    private void Recalculate()
    {
        subtotal = 0;
        foreach (var c in cart)
        {
            if (c.ItemDiscountType == ClothsStoreSys.Models.DiscountType.Percent)
                c.ItemDiscountAmount = c.UnitPrice * c.Quantity * (c.ItemDiscountValue / 100);
            else if (c.ItemDiscountType == ClothsStoreSys.Models.DiscountType.Fixed)
                c.ItemDiscountAmount = c.ItemDiscountValue * c.Quantity;
            else c.ItemDiscountAmount = 0;

            c.Total = (c.UnitPrice * c.Quantity) - c.ItemDiscountAmount;
            subtotal += c.Total;
        }

        if (invoiceDiscountType == ClothsStoreSys.Models.DiscountType.Percent)
            invoiceDiscountAmount = subtotal * (invoiceDiscountValue / 100);
        else if (invoiceDiscountType == ClothsStoreSys.Models.DiscountType.Fixed)
            invoiceDiscountAmount = invoiceDiscountValue;
        else invoiceDiscountAmount = 0;

        total = subtotal - invoiceDiscountAmount;
    }

    private async Task Finalize()
    {
        var invoice = new ClothsStoreSys.Models.Invoice
        {
            CashierId = 1,
            InvoiceDiscountType = invoiceDiscountType,
            InvoiceDiscountValue = invoiceDiscountValue,
            Status = ClothsStoreSys.Models.InvoiceStatus.Paid
        };

        await InvoiceService.CreateInvoiceAsync(invoice, cart);
        cart.Clear();
        Recalculate();
    }
}
